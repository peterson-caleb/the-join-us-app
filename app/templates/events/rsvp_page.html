{% extends "base.html" %}

{% block title %}RSVP for {{ event.name }}{% endblock %}

{% block extra_css %}
<style>
    .rsvp-card .card-body { padding: 2rem; }
    .status-banner { padding: 1rem; border-radius: 0.5rem; font-weight: 500; }
    .status-yes { background-color: var(--success-50); color: var(--success-800); border: 1px solid var(--success-200); }
    .status-no { background-color: var(--danger-50); color: var(--danger-800); border: 1px solid var(--danger-200); }
    .btn-yes.active, .btn-yes:hover { background-color: var(--success-600) !important; border-color: var(--success-600) !important; }
    .btn-no.active, .btn-no:hover { background-color: var(--danger-600) !important; border-color: var(--danger-600) !important; }
    .toast-container { z-index: 1090; }
</style>
{% endblock %}


{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div id="rsvp-card" class="card rsvp-card">
                <div class="card-header">
                    <h2 class="mb-0">You're Invited!</h2>
                </div>
                <div class="card-body text-center">
                    <div id="status-container" class="mb-4">
                        {% if invitee.status == 'YES' %}
                        <div class="status-banner status-yes">
                            <i class="bi bi-check-circle-fill"></i> You have confirmed you are attending.
                        </div>
                        {% elif invitee.status == 'NO' %}
                        <div class="status-banner status-no">
                            <i class="bi bi-x-circle-fill"></i> You have responded that you are not attending.
                        </div>
                        {% endif %}
                    </div>

                    <h3 class="card-title">{{ event.name }}</h3>
                    <p class="card-text">
                        A message for you, {{ invitee.name }}.
                    </p>
                    <p class="lead">
                        The event is on <strong>{{ event.date.strftime('%A, %B %d, %Y') if event.date else 'a future date' }}</strong>.
                        {% if event.start_time %}
                            It starts at <strong>{{ event.start_time }}</strong>.
                        {% endif %}
                    </p>
                    {% if event.location %}
                    <p class="text-muted">
                        <i class="bi bi-geo-alt-fill"></i> Location: <strong>{{ event.location }}</strong>
                    </p>
                    {% endif %}
                    
                    <p class="lead mt-3">
                        {% if invitee.status in ['YES', 'NO'] %}
                            Would you like to change your response?
                        {% else %}
                            Will you be attending?
                        {% endif %}
                    </p>
                    
                    {% if expiry_datetime_est %}
                    <div class="alert alert-warning small">
                        Please respond by {{ expiry_datetime_est.strftime('%A, %B %d at %I:%M %p %Z') }}
                    </div>
                    {% endif %}

                    {% if event.details %}
                    <div class="alert alert-info mt-3 text-start">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Event Details:</strong>
                        <div class="mt-2">{{ event.details }}</div>
                    </div>
                    {% endif %}
                    <div id="rsvp-buttons" class="d-grid gap-2 d-sm-flex justify-content-sm-center mt-4">
                        <button class="btn btn-success btn-lg px-4 gap-3 btn-yes {% if invitee.status == 'YES' %}active{% endif %}" data-response="YES">
                            <i class="bi bi-check-circle"></i> Yes, I'll be there!
                        </button>
                        <button class="btn btn-danger btn-lg px-4 btn-no {% if invitee.status == 'NO' %}active{% endif %}" data-response="NO">
                            <i class="bi bi-x-circle"></i> No, I can't make it
                        </button>
                    </div>
                    
                    <div id="post-rsvp-info" class="mt-4">
                        {# BUGFIX: Render capacity bar on initial load if user is already confirmed #}
                        {% if capacity_details %}
                            {% set total_confirmed = capacity_details.confirmed + (1 if capacity_details.organizer_attending else 0) %}
                            {% set capacity = capacity_details.capacity %}
                            {% set confirmed_percent = ((total_confirmed / capacity) * 100)|round %}
                            {% set organizer_text = '(incl. organizer)' if capacity_details.organizer_attending else '' %}
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title text-center mb-3">Event Capacity</h5>
                                    <div class="d-flex justify-content-between align-items-center small text-muted mb-2">
                                        <span><strong>{{ total_confirmed }}</strong> confirmed of <strong>{{ capacity }}</strong> spots {{ organizer_text }}</span>
                                        <span class="fw-bold">{{ confirmed_percent }}% Full</span>
                                    </div>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: {{ confirmed_percent }}%" aria-valuenow="{{ confirmed_percent }}" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <div class="text-center mt-3">
                                        <a href="{{ url_for('events.generate_ics', event_id=event._id) }}" class="btn btn-outline-primary">
                                            <i class="bi bi-calendar-plus"></i> Add to Calendar
                                        </a>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="card-footer text-muted">
                    <small>Your response is important to us.</small>
                </div>
            </div>

            <div id="attendee-list-container">
                {% if confirmed_guests %}
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-people-fill me-2"></i>Confirmed Attendees</h5>
                    </div>
                    <ul class="list-group list-group-flush">
                        {% for guest_name in confirmed_guests %}
                            <li class="list-group-item">{{ guest_name }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="rsvpToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto" id="toast-title"></strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toast-body">
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const rsvpButtons = document.querySelectorAll('#rsvp-buttons button');
    const token = "{{ token }}";
    const eventId = "{{ event._id }}";
    const statusContainer = document.getElementById('status-container');
    const postRsvpContainer = document.getElementById('post-rsvp-info');
    const attendeeListContainer = document.getElementById('attendee-list-container');
    const toastElement = document.getElementById('rsvpToast');
    const toast = new bootstrap.Toast(toastElement);

    rsvpButtons.forEach(button => {
        button.addEventListener('click', function () {
            const response = this.dataset.response;
            submitRsvp(response);
        });
    });

    function showToast(title, message, isSuccess) {
        const toastTitle = document.getElementById('toast-title');
        const toastBody = document.getElementById('toast-body');
        toastTitle.textContent = title;
        toastBody.textContent = message;
        
        toastElement.classList.remove('text-bg-success', 'text-bg-danger');
        if (isSuccess) {
            toastElement.classList.add('text-bg-success');
        } else {
            toastElement.classList.add('text-bg-danger');
        }
        
        toast.show();
    }

    function updateStatusUI(response) {
        let bannerHtml = '';
        if (response === 'YES') {
            bannerHtml = `<div class="status-banner status-yes"><i class="bi bi-check-circle-fill"></i> You have confirmed you are attending.</div>`;
            document.querySelector('.btn-yes').classList.add('active');
            document.querySelector('.btn-no').classList.remove('active');
        } else if (response === 'NO') {
            bannerHtml = `<div class="status-banner status-no"><i class="bi bi-x-circle-fill"></i> You have responded that you are not attending.</div>`;
            document.querySelector('.btn-no').classList.add('active');
            document.querySelector('.btn-yes').classList.remove('active');
            postRsvpContainer.innerHTML = ''; 
            attendeeListContainer.innerHTML = '';
        }
        statusContainer.innerHTML = bannerHtml;
    }

    function renderCapacityBar(details) {
        const totalConfirmed = details.confirmed + (details.organizer_attending ? 1 : 0);
        const capacity = details.capacity;
        const confirmedPercent = Math.round((totalConfirmed / capacity) * 100);
        const organizerText = details.organizer_attending ? '(incl. organizer)' : '';
        
        const barHtml = `
        <div class="card">
            <div class="card-body">
                <h5 class="card-title text-center mb-3">Event Capacity</h5>
                <div class="d-flex justify-content-between align-items-center small text-muted mb-2">
                    <span><strong>${totalConfirmed}</strong> confirmed of <strong>${capacity}</strong> spots ${organizerText}</span>
                    <span class="fw-bold">${confirmedPercent}% Full</span>
                </div>
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar bg-success" role="progressbar" style="width: ${confirmedPercent}%" aria-valuenow="${confirmedPercent}" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div class="text-center mt-3">
                    <a href="/event/${eventId}/calendar.ics" class="btn btn-outline-primary">
                        <i class="bi bi-calendar-plus"></i> Add to Calendar
                    </a>
                </div>
            </div>
        </div>
        `;
        postRsvpContainer.innerHTML = barHtml;
    }

    function renderAttendeeList(guests) {
        if (!guests || guests.length === 0) {
            attendeeListContainer.innerHTML = '';
            return;
        }

        let listItems = '';
        guests.forEach(guest => {
            listItems += `<li class="list-group-item">${guest}</li>`;
        });

        const listHtml = `
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-people-fill me-2"></i>Confirmed Attendees</h5>
            </div>
            <ul class="list-group list-group-flush">
                ${listItems}
            </ul>
        </div>`;
        attendeeListContainer.innerHTML = listHtml;
    }

    function setLoadingState(isLoading) {
        rsvpButtons.forEach(button => {
            if (isLoading) {
                button.disabled = true;
                button.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>  Saving...`;
            } else {
                button.disabled = false;
                const icon = button.dataset.response === 'YES' ? 'bi-check-circle' : 'bi-x-circle';
                const text = button.dataset.response === 'YES' ? "Yes, I'll be there!" : "No, I can't make it";
                button.innerHTML = `<i class="bi ${icon}"></i> ${text}`;
            }
        });
    }

    async function submitRsvp(response) {
        setLoadingState(true);
        try {
            const res = await fetch(`/api/rsvp/${token}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ response: response }),
            });
            const data = await res.json();

            if (data.success) {
                showToast('Success!', data.message, true);
                updateStatusUI(response);
                if (data.capacity_details) {
                    renderCapacityBar(data.capacity_details);
                }
                if (data.confirmed_guests) {
                    renderAttendeeList(data.confirmed_guests);
                }
            } else {
                showToast('Error', data.message, false);
            }

        } catch (error) {
            showToast('Network Error', 'Could not submit your RSVP. Please try again later.', false);
        } finally {
            setLoadingState(false);
        }
    }
});
</script>
{% endblock %}