{% extends "base.html" %}

{% block title %}Manage Invitees - {{ event.name }}{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/dragula@3.7.3/dist/dragula.min.css" rel="stylesheet">
<style>
    .invitee-list { min-height: 200px; border: 1px solid #dee2e6; border-radius: 0.25rem; padding: 1rem; background: #f8f9fa; }
    .invitee-item { background: white; padding: 0.75rem; margin-bottom: 0.5rem; border: 1px solid #dee2e6; border-radius: 0.25rem; }
    .invitee-item:last-child { margin-bottom: 0; }
    .invitee-item.is-dragging { opacity: 0.5; }
    .status-indicator { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
    .status-pending { background-color: #6c757d; } .status-invited { background-color: #0d6efd; }
    .status-yes { background-color: #198754; } .status-no { background-color: #dc3545; }
    .status-expired { background-color: #ffc107; } .status-error { background-color: #dc3545; }

    /* --- STYLES FOR MOBILE REORDERING --- */
    .mobile-reorder-controls {
        display: none; /* Hidden by default */
    }

    .reorder-btn {
        background: none;
        border: none;
        color: var(--bs-secondary-color);
        padding: 0; /* Adjusted padding */
        line-height: 1; /* Aligns icons nicely when stacked */
        cursor: pointer;
    }
    .reorder-btn:hover {
        color: var(--bs-primary);
    }
    .reorder-btn:disabled {
        color: var(--bs-tertiary-color);
        cursor: not-allowed;
    }

    /* Show and stack controls on mobile */
    @media (max-width: 991.98px) {
        .invitee-item {
            cursor: default; /* Remove move cursor on mobile */
        }
        .mobile-reorder-controls {
            display: flex; /* Show buttons */
            flex-direction: column; /* Stack them vertically */
            justify-content: center; /* Center them in the column */
            gap: 0.5rem; /* Adds a small space between the buttons */
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1>{{ event.name }}</h1>
                    <p class="text-muted mb-0">Event Date: {{ event.date.strftime('%Y-%m-%d') }} | Capacity: {{ event.capacity }}</p>
                </div>
                <a href="{{ url_for('events.manage_events') }}" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> Back to Events</a>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        Current Invitees
                        {% if event.automation_status == 'paused' %}
                            <span class="badge rounded-pill bg-warning-subtle text-warning-emphasis fw-medium ms-2">Paused</span>
                        {% else %}
                            <span class="badge rounded-pill bg-success-subtle text-success-emphasis fw-medium ms-2">Active</span>
                        {% endif %}
                    </h5>
                    <div>
                        <form action="{{ url_for('events.toggle_automation', event_id=event._id) }}" method="POST" class="d-inline">
                            {% if event.automation_status == 'paused' %}
                                <button type="submit" class="btn btn-success btn-sm">
                                    <i class="bi bi-play-circle-fill me-1"></i> Start Automation
                                </button>
                            {% else %}
                                <button type="submit" class="btn btn-warning btn-sm">
                                    <i class="bi bi-pause-circle-fill me-1"></i> Pause Automation
                                </button>
                            {% endif %}
                        </form>
                    </div>
                </div>
                <div class="card-body">
                    <div class="alert alert-info d-lg-none"><i class="bi bi-arrows-move"></i> Use the arrow buttons to reorder on mobile. Drag and drop is available on desktop.</div>
                    <div class="invitee-list" id="inviteeList">
                        {% for invitee in event.invitees|sort(attribute='priority') %}
                        <div class="invitee-item" data-id="{{ invitee._id }}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <div class="mobile-reorder-controls me-2">
                                        <button class="reorder-btn reorder-up" aria-label="Move up"><i class="bi bi-arrow-up-circle fs-5"></i></button>
                                        <button class="reorder-btn reorder-down" aria-label="Move down"><i class="bi bi-arrow-down-circle fs-5"></i></button>
                                    </div>
                                    <div>
                                        <span class="status-indicator status-{{ invitee.status|lower if invitee.status else 'pending' }}" 
                                              data-bs-toggle="tooltip" 
                                              title="{{ invitee.error_message if invitee.error_message else invitee.status|capitalize }}"></span>
                                        <strong>{{ invitee.name }}</strong>
                                        <small class="text-muted">({{ invitee.phone }})</small>
                                    </div>
                                </div>
                                
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="bi bi-three-dots-vertical"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><form action="{{ url_for('events.manual_rsvp', event_id=event._id, invitee_id=invitee._id) }}" method="POST" class="dropdown-item-form"><input type="hidden" name="status" value="YES"><button type="submit" class="btn dropdown-item"><i class="bi bi-check-circle me-2"></i>Manually Confirm</button></form></li>
                                        <li><form action="{{ url_for('events.manual_rsvp', event_id=event._id, invitee_id=invitee._id) }}" method="POST" class="dropdown-item-form"><input type="hidden" name="status" value="NO"><button type="submit" class="btn dropdown-item"><i class="bi bi-x-circle me-2"></i>Manually Decline</button></form></li>
                                        {% if invitee.status == 'ERROR' %}
                                        <li><form action="{{ url_for('events.retry_invitee', event_id=event._id, invitee_id=invitee._id) }}" method="POST" class="dropdown-item-form"><button type="submit" class="btn dropdown-item"><i class="bi bi-arrow-clockwise me-2"></i>Retry Invitation</button></form></li>
                                        {% endif %}
                                        <li><hr class="dropdown-divider"></li>
                                        <li><form action="{{ url_for('events.delete_invitee', event_id=event._id, invitee_id=invitee._id) }}" method="POST" class="dropdown-item-form" onsubmit="return confirm('Remove {{ invitee.name }}?')"><button type="submit" class="btn dropdown-item text-danger"><i class="bi bi-trash me-2"></i>Remove Invitee</button></form></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card mb-3">
                <div class="card-header"><h5 class="mb-0">Add Invitees from Master List</h5></div>
                <div class="card-body">
                    <form action="{{ url_for('events.add_invitees', event_id=event._id) }}" method="POST">
                        <div class="mb-3">
                            <label for="tag-filter-select" class="form-label">Filter by Tags:</label>
                            <select id="tag-filter-select" class="form-select" multiple>
                                {% for tag in all_tags %}
                                    <option value="{{ tag }}">{{ tag }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="invitees-select" class="form-label">Select people to invite:</label>
                            <select name="invitees_to_add" id="invitees-select" class="form-select" multiple>
                                {% for contact in contacts %}
                                    {% if contact._id not in current_invitee_ids %}
                                        <option value="{{ contact._id }}">{{ contact.name }} ({{ contact.phone }})</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-100"><i class="bi bi-plus-circle"></i> Add Selected to Event</button>
                    </form>
                </div>
            </div>

            <!-- NEW: Send Message Card -->
            <div class="card">
                <div class="card-header"><h5 class="mb-0"><i class="bi bi-chat-dots me-2"></i>Send Message to Invitees</h5></div>
                <div class="card-body">
                    <form action="{{ url_for('events.send_message', event_id=event._id) }}" method="POST" id="messageForm">
                        <div class="mb-3">
                            <label for="recipient_type" class="form-label">Send to:</label>
                            <select name="recipient_type" id="recipient_type" class="form-select" required>
                                <option value="confirmed">Confirmed Attendees Only</option>
                                <option value="all">All Invited Attendees</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="message_text" class="form-label">Message:</label>
                            <textarea name="message_text" id="message_text" class="form-control" rows="3" maxlength="160" required placeholder="Your message will be prefixed with 'Event Msg: '"></textarea>
                            <div class="form-text d-flex justify-content-between">
                                <span>Message will be prefixed with "Event Msg: "</span>
                                <span id="charCount">0/160 characters</span>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100"><i class="bi bi-send me-2"></i>Send Message</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/dragula@3.7.3/dist/dragula.min.js"></script>
<script>
    const allContacts = {{ contacts|tojson }};
    const currentInviteeIds = {{ current_invitee_ids|tojson|safe }};
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const inviteeList = document.getElementById('inviteeList');

    // --- Function to save the order ---
    function saveOrder() {
        const inviteeOrder = Array.from(inviteeList.children).map(item => item.dataset.id);
        fetch(`/events/{{ event._id }}/reorder_invitees`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ invitee_order: inviteeOrder })
        }).catch(err => console.error('Error reordering invitees:', err));
    }
    
    // --- Initialize Dragula for DESKTOP only ---
    if (window.matchMedia("(min-width: 992px)").matches) {
        var drake = dragula([inviteeList], {
            moves: function (el, source, handle, sibling) {
                return true;
            }
        });
        drake.on('drop', () => {
            saveOrder();
            updateButtonStates();
        });
    }

    // --- Handle mobile reorder button clicks ---
    inviteeList.addEventListener('click', function(e) {
        const upButton = e.target.closest('.reorder-up');
        const downButton = e.target.closest('.reorder-down');
        
        if (upButton) {
            const item = upButton.closest('.invitee-item');
            const prevItem = item.previousElementSibling;
            if (prevItem) {
                inviteeList.insertBefore(item, prevItem);
                saveOrder();
                updateButtonStates();
            }
        }

        if (downButton) {
            const item = downButton.closest('.invitee-item');
            const nextItem = item.nextElementSibling;
            if (nextItem) {
                inviteeList.insertBefore(nextItem, item);
                saveOrder();
                updateButtonStates();
            }
        }
    });

    // --- Function to disable/enable first/last buttons ---
    function updateButtonStates() {
        const items = inviteeList.querySelectorAll('.invitee-item');
        items.forEach((item, index) => {
            const upBtn = item.querySelector('.reorder-up');
            const downBtn = item.querySelector('.reorder-down');
            if (upBtn) upBtn.disabled = (index === 0);
            if (downBtn) downBtn.disabled = (index === items.length - 1);
        });
    }

    // --- Existing JS for Select2 and Tooltips ---
    const tagFilterSelect = $('#tag-filter-select');
    const inviteesSelect = $('#invitees-select');

    tagFilterSelect.select2({ theme: 'bootstrap-5', width: '100%', placeholder: 'Filter contacts by tag...' });
    inviteesSelect.select2({ theme: 'bootstrap-5', width: '100%', placeholder: 'Type a name to search...' });

    tagFilterSelect.on('change', function() {
        const selectedTags = $(this).val();
        const filteredContacts = allContacts.filter(contact => {
            if (currentInviteeIds.includes(contact._id)) return false;
            if (!selectedTags || selectedTags.length === 0) return true;
            return contact.tags && contact.tags.some(tag => selectedTags.includes(tag));
        });

        inviteesSelect.empty();
        filteredContacts.forEach(contact => {
            const newOption = new Option(`${contact.name} (${contact.phone})`, contact._id, false, false);
            inviteesSelect.append(newOption);
        });
        inviteesSelect.trigger('change');
    });

    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });

    // Initial button state update on page load
    updateButtonStates();

    // --- Character Counter for Message ---
    const messageTextarea = document.getElementById('message_text');
    const charCount = document.getElementById('charCount');
    
    messageTextarea.addEventListener('input', function() {
        const length = this.value.length;
        charCount.textContent = `${length}/160 characters`;
        
        // Optional: Change color when approaching limit
        if (length > 140) {
            charCount.classList.add('text-warning');
        } else {
            charCount.classList.remove('text-warning');
        }
        
        if (length === 160) {
            charCount.classList.add('text-danger');
            charCount.classList.remove('text-warning');
        } else {
            charCount.classList.remove('text-danger');
        }
    });
});
</script>
{% endblock %}