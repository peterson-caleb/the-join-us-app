{% extends "base.html" %}

{% block title %}Manage Invitees - {{ event.name }}{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/dragula@3.7.3/dist/dragula.min.css" rel="stylesheet">
<style>
    .invitee-list { min-height: 200px; border: 1px solid #dee2e6; border-radius: 0.25rem; padding: 1rem; background: #f8f9fa; }
    .invitee-item { background: white; padding: 0.75rem; margin-bottom: 0.5rem; border: 1px solid #dee2e6; border-radius: 0.25rem; cursor: move; }
    .invitee-item:last-child { margin-bottom: 0; }
    .invitee-item.is-dragging { opacity: 0.5; }
    .status-indicator { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
    .status-pending { background-color: #6c757d; } .status-invited { background-color: #0d6efd; }
    .status-yes { background-color: #198754; } .status-no { background-color: #dc3545; }
    .status-expired { background-color: #ffc107; } .status-error { background-color: #dc3545; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1>{{ event.name }}</h1>
                    <p class="text-muted mb-0">Event Date: {{ event.date.strftime('%Y-%m-%d') }} | Capacity: {{ event.capacity }}</p>
                </div>
                <a href="{{ url_for('events.manage_events') }}" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> Back to Events</a>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    {# --- MODIFICATION START --- #}
                    <h5 class="mb-0">
                        Current Invitees
                        {% if event.automation_status == 'paused' %}
                            <span class="badge rounded-pill bg-warning-subtle text-warning-emphasis fw-medium ms-2">Paused</span>
                        {% else %}
                            <span class="badge rounded-pill bg-success-subtle text-success-emphasis fw-medium ms-2">Active</span>
                        {% endif %}
                    </h5>
                    <div>
                        <form action="{{ url_for('events.toggle_automation', event_id=event._id) }}" method="POST" class="d-inline">
                            {% if event.automation_status == 'paused' %}
                                <button type="submit" class="btn btn-success btn-sm">
                                    <i class="bi bi-play-circle-fill me-1"></i> Start Automation
                                </button>
                            {% else %}
                                <button type="submit" class="btn btn-warning btn-sm">
                                    <i class="bi bi-pause-circle-fill me-1"></i> Pause Automation
                                </button>
                            {% endif %}
                        </form>
                    </div>
                    {# --- MODIFICATION END --- #}
                </div>
                <div class="card-body">
                    <div class="invitee-list" id="inviteeList">
                        {% for invitee in event.invitees|sort(attribute='priority') %}
                        <div class="invitee-item" data-id="{{ invitee._id }}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="status-indicator status-{{ invitee.status|lower if invitee.status else 'pending' }}" 
                                          data-bs-toggle="tooltip" 
                                          title="{{ invitee.error_message if invitee.error_message else invitee.status|capitalize }}"></span>
                                    <strong>{{ invitee.name }}</strong>
                                    <small class="text-muted">({{ invitee.phone }})</small>
                                </div>
                                <div>
                                    {% if invitee.status in ['pending', 'invited'] %}
                                    <form action="{{ url_for('events.manual_rsvp', event_id=event._id, invitee_id=invitee._id) }}" method="POST" class="d-inline">
                                        <input type="hidden" name="status" value="YES">
                                        <button type="submit" class="btn btn-sm btn-outline-success" title="Manually Confirm">
                                            <i class="bi bi-check-circle"></i>
                                        </button>
                                    </form>
                                    <form action="{{ url_for('events.manual_rsvp', event_id=event._id, invitee_id=invitee._id) }}" method="POST" class="d-inline">
                                        <input type="hidden" name="status" value="NO">
                                        <button type="submit" class="btn btn-sm btn-outline-danger" title="Manually Decline">
                                            <i class="bi bi-x-circle"></i>
                                        </button>
                                    </form>
                                    {% endif %}

                                    {% if invitee.status == 'ERROR' %}
                                    <form action="{{ url_for('events.retry_invitee', event_id=event._id, invitee_id=invitee._id) }}" method="POST" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-outline-warning me-2">
                                            <i class="bi bi-arrow-clockwise"></i> Retry
                                        </button>
                                    </form>
                                    {% endif %}
                                    
                                    <form action="{{ url_for('events.delete_invitee', event_id=event._id, invitee_id=invitee._id) }}" method="POST" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Remove {{ invitee.name }}?')">Remove</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-header"><h5 class="mb-0">Add Invitees from Master List</h5></div>
                <div class="card-body">
                    <form action="{{ url_for('events.add_invitees', event_id=event._id) }}" method="POST">
                        <div class="mb-3">
                            <label for="invitees-select" class="form-label">Select people to invite:</label>
                            <select name="invitees_to_add" id="invitees-select" class="form-select" multiple>
                                {% for contact in contacts %}
                                    {% if contact._id not in current_invitee_ids %}
                                        <option value="{{ contact._id }}">{{ contact.name }} ({{ contact.phone }})</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-100"><i class="bi bi-plus-circle"></i> Add Selected to Event</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/dragula@3.7.3/dist/dragula.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Select2 on the invitee selection box
    $('#invitees-select').select2({
        theme: 'bootstrap-5',
        width: '100%',
        placeholder: 'Type a name to search...'
    });
    
    // Re-initialize tooltips after changes
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });

    var drake = dragula([document.getElementById('inviteeList')]);
    drake.on('drop', (el, target) => {
        const inviteeOrder = Array.from(target.children).map(item => item.dataset.id);
        fetch(`/events/{{ event._id }}/reorder_invitees`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ invitee_order: inviteeOrder })
        }).catch(err => console.error('Error reordering invitees:', err));
    });
});
</script>
{% endblock %}